<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Advance - The Tonbo Guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">What is Tonbo?</a></li><li class="chapter-item expanded "><a href="../start.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Usage</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/tonbo.html"><strong aria-hidden="true">2.1.</strong> Tonbo</a></li><li class="chapter-item expanded "><a href="../usage/python.html"><strong aria-hidden="true">2.2.</strong> Python Binding</a></li><li class="chapter-item expanded "><a href="../usage/conf.html"><strong aria-hidden="true">2.3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../usage/advance.html" class="active"><strong aria-hidden="true">2.4.</strong> Advance</a></li><li class="chapter-item expanded "><a href="../usage/faq.html"><strong aria-hidden="true">2.5.</strong> FAQ</a></li></ol></li><li class="chapter-item expanded "><a href="../examples/index.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/declare.html"><strong aria-hidden="true">3.1.</strong> Using Tonbo</a></li><li class="chapter-item expanded "><a href="../examples/wasm.html"><strong aria-hidden="true">3.2.</strong> Using under Wasm</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Contribution</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contribution/build.html"><strong aria-hidden="true">4.1.</strong> Building</a></li><li class="chapter-item expanded "><a href="../contribution/pr.html"><strong aria-hidden="true">4.2.</strong> Submitting PR</a></li><li class="chapter-item expanded "><a href="../contribution/composite_primary_keys.html"><strong aria-hidden="true">4.3.</strong> Composite Primary Keys</a></li></ol></li><li class="chapter-item expanded "><a href="../tonbolite/index.html"><strong aria-hidden="true">5.</strong> TonboLite</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tonbolite/start.html"><strong aria-hidden="true">5.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../tonbolite/build.html"><strong aria-hidden="true">5.2.</strong> Building and Testing</a></li><li class="chapter-item expanded "><a href="../tonbolite/usage.html"><strong aria-hidden="true">5.3.</strong> Usage</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Tonbo Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/tonbo-io/tonbo" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="explore-tonbo"><a class="header" href="#explore-tonbo">Explore Tonbo</a></h1>
<ul>
<li><a href="#dynrecord">DynRecord</a></li>
<li><a href="#operations">Operations</a>
<ul>
<li><a href="#create-database">Create Database</a></li>
<li><a href="#insert">Insert</a></li>
<li><a href="#remove">Remove</a></li>
<li><a href="#query">Query</a></li>
<li><a href="#transaction">Transaction</a></li>
</ul>
</li>
<li><a href="#using-s3-backends">Using S3 backends</a></li>
</ul>
<p>Tonbo provide <code>DynRecord</code> to support dynamic schema. We have been using it to build Python and WASM bindings for Tonbo. You can find the source code <a href="https://github.com/tonbo-io/tonbo/tree/main/bindings">here</a>.</p>
<p>Except using it in Python and WASM bindings for Tonbo, we have also used it to build a SQLite extension, <a href="https://github.com/tonbo-io/tonbolite">TonboLite</a>. This means that you can do more interesting things with tonbo such as building a PostgreSQL extension and integrating with datafusio.</p>
<h2 id="dynrecord"><a class="header" href="#dynrecord">DynRecord</a></h2>
<p><code>DynRecord</code> is just like the schema you defined by <code>#[derive(Record)]</code>, but the fields are not known at compile time. Therefore, before using it, you need to pass the schema and value by yourself. Here is the constructor of the <code>DynSchema</code>, the schema of <code>DynRecord</code>:</p>
<pre><code class="language-rust">// constructor of DynSchema
pub fn new(schema: Vec&lt;ValueDesc&gt;, primary_index: usize) -&gt; DynSchema;

// constructor of ValueDesc
pub fn new(name: String, datatype: DataType, is_nullable: bool) -&gt; ValueDesc;</code></pre>
<ul>
<li><code>ValueDesc</code>: represents a field of schema, which contains field name, field type.
<ul>
<li><code>name</code>: represents the name of the field.</li>
<li><code>datatype</code>: represents the data type of the field.</li>
<li><code>is_nullable</code>: represents whether the field can be nullable.</li>
</ul>
</li>
<li><code>primary_index</code>: represents the index of the primary key field in the schema.</li>
</ul>
<pre><code class="language-rust">pub fn new(values: Vec&lt;Value&gt;, primary_index: usize) -&gt; DynRecord;

pub fn new(
    datatype: DataType,
    name: String,
    value: Arc&lt;dyn Any + Send + Sync&gt;,
    is_nullable: bool,
) -&gt; Value;
</code></pre>
<ul>
<li><code>Value</code>: represents a field of schema and its value, which contains a field description and the value.
<ul>
<li><code>datatype</code>: represents the data type of the field.</li>
<li><code>name</code>: represents the name of the field.</li>
<li><code>is_nullable</code>: represents whether the field is nullable.</li>
<li><code>value</code>: represents the value of the field.</li>
</ul>
</li>
<li><code>primary_index</code>: represents the index of the primary key field in the schema.</li>
</ul>
<p>Now, tonbo support these types for dynamic schema:</p>
<div class="table-wrapper"><table><thead><tr><th>Tonbo type</th><th>Rust type</th></tr></thead><tbody>
<tr><td><code>UInt8</code>/<code>UInt16</code>/<code>UInt32</code>/<code>UInt64</code></td><td><code>u8</code>/<code>u16</code>/<code>u32</code>/<code>u64</code></td></tr>
<tr><td><code>Int8</code>/<code>Int16</code>/<code>Int32</code>/<code>Int64</code></td><td><code>i8</code>/<code>i16</code>/<code>i32</code>/<code>i64</code></td></tr>
<tr><td><code>Boolean</code></td><td><code>bool</code></td></tr>
<tr><td><code>String</code></td><td><code>String</code></td></tr>
<tr><td><code>Bytes</code></td><td><code>Vec&lt;u8&gt;</code></td></tr>
</tbody></table>
</div>
<p>It allows you to define a schema at runtime and use it to create records. This is useful when you need to define a schema dynamically or when you need to define a schema that is not known at compile time.</p>
<h2 id="operations"><a class="header" href="#operations">Operations</a></h2>
<p>After creating <code>DynSchema</code>, you can use tonbo just like before. The only difference is that what you insert and get is the type of <code>DynRecord</code> and <code>DynRecordRef</code>.</p>
<p>If you compare the usage with compile-time schema version, you will find that the usage is almost the same. The difference can be summarized into the following 5 points.</p>
<ul>
<li>Use <code>DynSchema</code> to replace <code>xxxSchema</code>(e.g. <code>UserSchema</code>)</li>
<li>Use <code>DynRecord</code> instance to replace the instance you defined with <code>#[derive(Record)]</code></li>
<li>All you get from database is <code>DynRecordRef</code> rather than <code>xxxRef</code>(e.g. <code>UserRef</code>)</li>
<li>Use <code>Value</code> as the <code>Key</code> of <code>DynRecord</code>. For example, you should pass a <code>Value</code> instance the <code>DB::get</code> method.</li>
<li>The value of <code>Value</code> should be the type of <code>Arc&lt;Option&lt;T&gt;&gt;</code> if the column can be nullable.</li>
</ul>
<p>But if you look at the code, you will find that both <code>DynSchema</code> and <code>xxxSchema</code> implement the <code>Schema</code> trait , both <code>DynRecord</code> and <code>xxxRecord</code> implement the <code>Record</code> trait and both <code>DynRecordRef</code> and <code>xxxRecordRef</code> implement the <code>RecordRef</code> trait. So there is only two difference between them</p>
<h3 id="create-database"><a class="header" href="#create-database">Create Database</a></h3>
<pre><code class="language-rust">#[tokio::main]
async fn main() {
    // make sure the path exists
    fs::create_dir_all(&quot;./db_path/users&quot;).unwrap();

    // build DynSchema
    let descs = vec![
        ValueDesc::new(&quot;name&quot;.to_string(), DataType::String, false),
        ValueDesc::new(&quot;email&quot;.to_string(), DataType::String, false),
        ValueDesc::new(&quot;age&quot;.to_string(), DataType::Int8, true),
    ];
    let schema = DynSchema::new(descs, 0);

    let options = DbOption::new(
        Path::from_filesystem_path(&quot;./db_path/users&quot;).unwrap(),
        &amp;schema,
    );

    let db = DB::&lt;DynRecord, TokioExecutor&gt;::new(options, TokioExecutor::default(), DynSchema)
        .await
        .unwrap();
}</code></pre>
<p>If you want to learn more about <code>DbOption</code>, you can refer to the <a href="conf.html">Configuration section</a>.</p>
<blockquote>
<p><strong>Note:</strong> You should make sure the path exists before creating <code>DBOption</code>.</p>
</blockquote>
<h3 id="insert"><a class="header" href="#insert">Insert</a></h3>
<p>You can use <code>db.insert(record)</code> or <code>db.insert_batch(records)</code> to insert new records into the database just like before. The difference is that you should build insert a <code>DynRecord</code> instance.</p>
<p>Here is an example of how to build a <code>DynRecord</code> instance:</p>
<pre><code class="language-rust">let mut columns = vec![
    Value::new(
        DataType::String,
        &quot;name&quot;.to_string(),
        Arc::new(&quot;Alice&quot;.to_string()),
        false,
    ),
    Value::new(
        DataType::String,
        &quot;email&quot;.to_string(),
        Arc::new(&quot;abc@tonbo.io&quot;.to_string()),
        false,
    ),
    Value::new(
        DataType::Int8,
        &quot;age&quot;.to_string(),
        Arc::new(Some(i as i8)),
        true,
    ),
];
let record = DynRecord::new(columns, 0);</code></pre>
<ul>
<li><code>Value::new</code> will create a new <code>Value</code> instance, which represents the value of the column in the schema. This method receives three parameters:
<ul>
<li>datatype: the data type of the field in the schema</li>
<li>name: the name of the field in the schema</li>
<li>value: the value of the column. This is the type of <code>Arc&lt;dyn Any&gt;</code>. But please be careful that <strong>the value should be the type of <code>Arc&lt;Option&lt;T&gt;&gt;</code> if the column can be nullable</strong>.</li>
<li>nullable: whether the value is nullable</li>
</ul>
</li>
</ul>
<pre><code class="language-rust">/// insert a single tonbo record
db.insert(record).await.unwrap();</code></pre>
<h3 id="remove"><a class="header" href="#remove">Remove</a></h3>
<p>You and use <code>db.remove(key)</code> to remove a record from the database. This method receives a <code>Key</code>, which is the primary key of the record. But all columns in the record is a <code>Value</code>, so you can not use it like <code>db.remove(&quot;Alice&quot;.into()).await.unwrap();</code>. Instead, you should pass a <code>Value</code> to <code>db.remove</code>.</p>
<pre><code class="language-rust">let key = Value::new(
    DataType::String,
    &quot;name&quot;.to_string(),
    Arc::new(&quot;Alice&quot;.to_string()),
    false,
);

db.remove(key).await.unwrap();</code></pre>
<h3 id="query"><a class="header" href="#query">Query</a></h3>
<p>You can use <code>get</code> method to get a record by key and you should pass a closure that takes a <code>TransactionEntry</code> instance and returns a <code>Option</code> type. You can use <code>TransactionEntry::get</code> to get a <code>DynRecordRef</code> instance.</p>
<p>You can use <code>scan</code> method to scan all records that in the specified range. <code>scan</code> method will return a <code>Stream</code> instance and you can iterate all records by using this stream.</p>
<pre><code class="language-rust">/// get the record with `key` as the primary key and process it using closure `f`
let age = db.get(key,
    |entry| {
        // entry.get() will get a `DynRecordRef`
        let record_ref = entry.get();
        println!(&quot;{:#?}&quot;, record_ref);
        record_ref.age
    })
    .await
    .unwrap();

let mut scan = db
    .scan((Bound::Included(&amp;lower_key), Bound::Excluded(&amp;upper_key)))
    .await
    .unwrap();
while let Some(entry) = scan.next().await.transpose().unwrap() {
    let data = entry.value(); // type of DynRecordRef
    // ......
}</code></pre>
<h3 id="transaction"><a class="header" href="#transaction">Transaction</a></h3>
<p>Tonbo supports transactions when using a <code>Transaction</code>. You can use <code>db.transaction()</code> to create a transaction, and use <code>txn.commit()</code> to commit the transaction.</p>
<p>Note that Tonbo provides optimistic concurrency control to ensure data consistency which means that if a transaction conflicts with another transaction when committing, Tonbo will fail with a <code>CommitError</code>.</p>
<p>Here is an example of how to use transactions:</p>
<pre><code class="language-rust">// create transaction
let txn = db.transaction().await;

let name = Value::new(
    DataType::String,
    &quot;name&quot;.to_string(),
    Arc::new(&quot;Alice&quot;.to_string()),
    false,
);
let upper = Value::new(
    DataType::String,
    &quot;name&quot;.to_string(),
    Arc::new(&quot;Bob&quot;.to_string()),
    false,
);

txn.insert(DynRecord::new(/* */));
let _record_ref = txn.get(&amp;name, Projection::Parts(vec![&quot;email&quot;, &quot;bytes&quot;])).await.unwrap();

// range scan of user
let mut scan = txn
    .scan((Bound::Included(&amp;name), Bound::Excluded(&amp;upper)))
    // tonbo supports pushing down projection
    .projection(&amp;[&quot;email&quot;, &quot;bytes&quot;])
    // push down limitation
    .limit(1)
    .take()
    .await
    .unwrap();

while let Some(entry) = scan.next().await.transpose().unwrap() {
    let data = entry.value(); // type of DynRecordRef
    // ......
}</code></pre>
<p>For more detail about transactions, please refer to the <a href="../transactions.html">Transactions</a> section.</p>
<h2 id="using-s3-backends"><a class="header" href="#using-s3-backends">Using S3 backends</a></h2>
<p>Using S3 as the backend storage is also similar to the usage of <a href="./tonbo.html#using-s3-backends">compile-time version</a>.</p>
<pre><code class="language-rust">use tonbo::option::{ AwsCredential, FsOptions, Path };
use tonbo::{executor::tokio::TokioExecutor, DbOption, DB};

#[tokio::main]
async fn main() {
    let fs_option = FsOptions::S3 {
        bucket: &quot;wasm-data&quot;.to_string(),
        credential: Some(AwsCredential {
            key_id: &quot;key_id&quot;.to_string(),
            secret_key: &quot;secret_key&quot;.to_string(),
            token: None,
        }),
        endpoint: None,
        sign_payload: None,
        checksum: None,
        region: Some(&quot;region&quot;.to_string()),
    };

    let descs = vec![
        ValueDesc::new(&quot;name&quot;.to_string(), DataType::String, false),
        ValueDesc::new(&quot;email&quot;.to_string(), DataType::String, false),
        ValueDesc::new(&quot;age&quot;.to_string(), DataType::Int8, true),
    ];
    let schema = DynSchema::new(descs, 0);
    let options = DbOption::new(Path::from_filesystem_path(&quot;s3_path&quot;).unwrap(), &amp;schema)
        .level_path(2, &quot;l2&quot;, fs_option);


    let db = DB::&lt;DynRecord, TokioExecutor&gt;::new(options, TokioExecutor::default(), schema)
        .await
        .unwrap();
}</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../usage/conf.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../usage/faq.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../usage/conf.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../usage/faq.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
