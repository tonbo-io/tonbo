name: benchmarks-nightly

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

jobs:
  nightly:
    name: scenario benchmarks (nightly)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-${{ runner.arch }}-bench-nightly-${{ hashFiles('**/Cargo.toml') }}
          cache-on-failure: false

      - name: Run mixed workload (preset ycsb_b)
        run: |
          cat benches/harness/configs/presets.yaml | yq '.presets.ycsb_b' > /tmp/bench.yaml
          cat /tmp/bench.yaml - <<'EOF' > /tmp/bench.yaml
          backend:
            type: disk
            path: target/bench-tmp
          EOF
          cargo bench --bench tonbo_scenarios -- --config /tmp/bench.yaml

      - name: Generate performance report
        run: |
          cargo run -p bench-report -- \
            --results-dir target/bench-results \
            --limit 10 \
            --output-md target/bench-reports/perf-report.md \
            --output-json target/bench-reports/perf-report.json

      - name: Upload nightly artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tonbo-benchmarks-nightly
          path: |
            target/bench-results/*.json
            target/bench-reports/perf-report.md
            target/bench-reports/perf-report.json
          if-no-files-found: ignore
